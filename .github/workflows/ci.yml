name: CI

# Trigger the workflow on push events to the main branch and on pull requests.
# It also runs on schedule (daily at midnight UTC).
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  schedule:
    - cron: '0 0 * * *' # Daily at midnight UTC

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        python-version:
          - "3.10"
          - "3.11"
          - "3.12"
          - "3.13"

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'uv'

      - name: Install Dependencies with uv
        # Installs dependencies from pyproject.toml. Uses uv for speed and efficiency.
        run: | 
          python -m pip install --upgrade pip uv
          uv pip install -r requirements.txt
          uv pip install -r requirements-dev.txt # For test/linting dependencies

      - name: Lint with Ruff
        # Uses Ruff to enforce code style and catch potential issues.
        run: uv pip run -m ruff check .

      - name: Format with Ruff
        # Uses Ruff to automatically format code according to defined style guides.
        run: uv pip run -m ruff format .

      - name: Test with Pytest
        # Runs all tests using Pytest. Includes coverage reporting.
        run: | 
          uv pip run -m pytest --cov=recruitypulse --cov-report=xml --junitxml=test-results.xml

      - name: Upload Coverage Reports
        # Uploads the coverage report to Codecov for analysis and visualization.
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }} # Ensure this token is set in GitHub Secrets
          fail_ci_if_error: true

      - name: Upload Test Results
        # Uploads JUnit test results for better visualization in GitHub Actions.
        uses: actions/upload-artifact@v4
        with:
          name: pytest-results-${{ matrix.python-version }}
          path: test-results.xml

      - name: Build CLI (Optional - If applicable)
        # Example: If the CLI needs to be built into an executable (e.g., using Poetry build or similar)
        # run: | 
        #   uv pip install build
        #   python -m build

      - name: Upload Artifacts (Optional)
        # If build step is used, upload the distribution files.
        # uses: actions/upload-artifact@v4
        # with:
        #   name: distribution-${{ matrix.python-version }}
        #   path: dist/
